<!doctype html>
<html lang="zh-CN" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-specification/fury_xlang_serialization_spec" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">Cross-language Serialization Specification | Apache Fury (incubating)</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://fury.apache.org/zh-CN/docs/specification/fury_xlang_serialization_spec"><meta data-rh="true" property="og:locale" content="zh_CN"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="zh-CN"><meta data-rh="true" name="docsearch:language" content="zh-CN"><meta data-rh="true" http-equiv="Content-Security-Policy" content="frame-src &#x27;self&#x27; https://ghbtns.com"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Cross-language Serialization Specification | Apache Fury (incubating)"><meta data-rh="true" name="description" content="Format Version History:"><meta data-rh="true" property="og:description" content="Format Version History:"><link data-rh="true" rel="icon" href="/zh-CN/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://fury.apache.org/zh-CN/docs/specification/fury_xlang_serialization_spec"><link data-rh="true" rel="alternate" href="https://fury.apache.org/docs/specification/fury_xlang_serialization_spec" hreflang="en"><link data-rh="true" rel="alternate" href="https://fury.apache.org/zh-CN/docs/specification/fury_xlang_serialization_spec" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://fury.apache.org/docs/specification/fury_xlang_serialization_spec" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/zh-CN/blog/rss.xml" title="Apache Fury (incubating) RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-CN/blog/atom.xml" title="Apache Fury (incubating) Atom Feed"><link rel="stylesheet" href="/zh-CN/assets/css/styles.ff7f39b6.css">
<script src="/zh-CN/assets/js/runtime~main.59175249.js" defer="defer"></script>
<script src="/zh-CN/assets/js/main.3af489ef.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-CN/"><div class="navbar__logo"><img src="/zh-CN/img/navbar-logo.svg" alt="Fury Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/zh-CN/img/navbar-logo.svg" alt="Fury Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh-CN/docs/start/install">开始</a><a class="navbar__item navbar__link" href="/zh-CN/docs/introduction/">介绍</a><a class="navbar__item navbar__link" href="/zh-CN/docs/guide/java_object_graph_guide">指南</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh-CN/docs/specification/fury_xlang_serialization_spec">规范</a><a class="navbar__item navbar__link" href="/zh-CN/docs/community/">社区</a><a class="navbar__item navbar__link" href="/zh-CN/download">下载</a><a href="https://github.com/apache/fury/issues/1793" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">FAQ</a><a class="navbar__item navbar__link" href="/zh-CN/blog">博客</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">基金会</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">许可证</a></li><li><a href="https://www.apache.org/events/current-event.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">事件</a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">隐私</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">安全</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">赞助</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">感谢</a></li><li><a href="https://www.apache.org/foundation/policies/conduct.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">行为准则</a></li></ul></div><a href="https://github.com/apache/fury" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中文（中国）</a><ul class="dropdown__menu"><li><a href="/docs/specification/fury_xlang_serialization_spec" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li><li><a href="/zh-CN/docs/specification/fury_xlang_serialization_spec" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-CN">中文（中国）</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/zh-CN/docs/specification/fury_xlang_serialization_spec">Cross-language Serialization Specification</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zh-CN/docs/specification/fury_java_serialization_spec">Fury Java Serialization Specification</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zh-CN/docs/specification/fury_row_format_spec">Fury Row Format</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/zh-CN/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Cross-language Serialization Specification</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Cross-language Serialization Specification</h1></header><blockquote>
<p>Format Version History:</p>
<ul>
<li>Version 0.1 - serialization spec formalized</li>
</ul>
</blockquote>
<p>Fury xlang serialization is an automatic object serialization framework that supports reference and polymorphism.
Fury will convert an object from/to fury xlang serialization binary format.
Fury has two core concepts for xlang serialization:</p>
<ul>
<li><strong>Fury xlang binary format</strong></li>
<li><strong>Framework implemented in different languages to convert object to/from Fury xlang binary format</strong></li>
</ul>
<p>The serialization format is a dynamic binary format. The dynamics and reference/polymorphism support make Fury flexible,
much more easy to use, but
also introduce more complexities compared to static serialization frameworks. So the format will be more complex.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="type-systems">Type Systems<a href="#type-systems" class="hash-link" aria-label="Type Systems的直接链接" title="Type Systems的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-types">Data Types<a href="#data-types" class="hash-link" aria-label="Data Types的直接链接" title="Data Types的直接链接">​</a></h3>
<ul>
<li>bool: a boolean value (true or false).</li>
<li>int8: a 8-bit signed integer.</li>
<li>int16: a 16-bit signed integer.</li>
<li>int32: a 32-bit signed integer.</li>
<li>var_int32: a 32-bit signed integer which use fury var_int32 encoding.</li>
<li>int64: a 64-bit signed integer.</li>
<li>var_int64: a 64-bit signed integer which use fury PVL encoding.</li>
<li>sli_int64: a 64-bit signed integer which use fury SLI encoding.</li>
<li>float16: a 16-bit floating point number.</li>
<li>float32: a 32-bit floating point number.</li>
<li>float64: a 64-bit floating point number including NaN and Infinity.</li>
<li>string: a text string encoded using Latin1/UTF16/UTF-8 encoding.</li>
<li>enum: a data type consisting of a set of named values. Rust enum with non-predefined field values are not supported as
an enum.</li>
<li>list: a sequence of objects.</li>
<li>set: an unordered set of unique elements.</li>
<li>map: a map of key-value pairs. Mutable types such as <code>list/map/set/array/tensor/arrow</code> are not allowed as key of map.</li>
<li>time types:<!-- -->
<ul>
<li>duration: an absolute length of time, independent of any calendar/timezone, as a count of nanoseconds.</li>
<li>timestamp: a point in time, independent of any calendar/timezone, as a count of nanoseconds. The count is relative
to an epoch at UTC midnight on January 1, 1970.</li>
</ul>
</li>
<li>decimal: exact decimal value represented as an integer value in two&#x27;s complement.</li>
<li>binary: an variable-length array of bytes.</li>
<li>array type: only allow numeric components. Other arrays will be taken as List. The implementation should support the
interoperability between array and list.<!-- -->
<ul>
<li>array: multidimensional array which every sub-array can have different sizes but all have same type.</li>
<li>bool_array: one dimensional int16 array.</li>
<li>int8_array: one dimensional int8 array.</li>
<li>int16_array: one dimensional int16 array.</li>
<li>int32_array: one dimensional int32 array.</li>
<li>int64_array: one dimensional int64 array.</li>
<li>float16_array: one dimensional half_float_16 array.</li>
<li>float32_array: one dimensional float32 array.</li>
<li>float64_array: one dimensional float64 array.</li>
</ul>
</li>
<li>tensor: a multidimensional dense array of fixed-size values such as a NumPy ndarray.</li>
<li>sparse tensor: a multidimensional array whose elements are almost all zeros.</li>
<li>arrow record batch: an arrow <a href="https://arrow.apache.org/docs/cpp/tables.html#record-batches" target="_blank" rel="noopener noreferrer">record batch</a> object.</li>
<li>arrow table: an arrow <a href="https://arrow.apache.org/docs/cpp/tables.html#tables" target="_blank" rel="noopener noreferrer">table</a> object.</li>
</ul>
<p>Note:</p>
<ul>
<li>Unsigned int/long are not added here, since not every language support those types.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="type-disambiguation">Type disambiguation<a href="#type-disambiguation" class="hash-link" aria-label="Type disambiguation的直接链接" title="Type disambiguation的直接链接">​</a></h3>
<p>Due to differences between type systems of languages, those types can&#x27;t be mapped one-to-one between languages. When
deserializing, Fury use the target data structure type and the data type in the data jointly to determine how to
deserialize and populate the target data structure. For example:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Foo</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> intArray</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">Object</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> objects</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> objectList</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Foo2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> intArray</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> objects</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> objectList</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>intArray</code> has an <code>int32_array</code> type. But both <code>objects</code> and <code>objectList</code> fields in the serialize data have <code>list</code> data
type. When deserializing, the implementation will create an <code>Object</code> array for <code>objects</code>, but create a <code>ArrayList</code>
for <code>objectList</code> to populate its elements. And the serialized data of <code>Foo</code> can be deserialized into <code>Foo2</code> too.</p>
<p>Users can also provide meta hints for fields of a type, or the type whole. Here is an example in java which use
annotation to provide such information.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@TypeInfo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fieldsNullable </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> trackingRef </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> polymorphic </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Foo</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token annotation punctuation" style="color:#393A34">@FieldInfo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">trackingRef </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> intArray</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token annotation punctuation" style="color:#393A34">@FieldInfo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">polymorphic </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">Object</span><span class="token plain"> object</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token annotation punctuation" style="color:#393A34">@FieldInfo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tagId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nullable </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">List</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Object</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> objectList</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Such information can be provided in other languages too:</p>
<ul>
<li>cpp: use macro and template.</li>
<li>golang: use struct tag.</li>
<li>python: use typehint.</li>
<li>rust: use macro.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="type-id">Type ID<a href="#type-id" class="hash-link" aria-label="Type ID的直接链接" title="Type ID的直接链接">​</a></h3>
<p>All internal data types are expressed using an ID in range <code>-64~-1</code>. Users can use <code>0~32703</code> for representing their
types. At runtime, all type ids are added by <code>64</code>, and then encoded as an unsigned varint.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="type-mapping">Type mapping<a href="#type-mapping" class="hash-link" aria-label="Type mapping的直接链接" title="Type mapping的直接链接">​</a></h3>
<p>See <a href="/zh-CN/docs/guide/xlang_type_mapping">Type mapping</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="spec-overview">Spec overview<a href="#spec-overview" class="hash-link" aria-label="Spec overview的直接链接" title="Spec overview的直接链接">​</a></h2>
<p>Here is the overall format:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">| fury header | object ref meta | object type meta | object value data |</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The data are serialized using little endian byte order overall. If bytes swap is costly for some object,
Fury will write the byte order for that object into the data instead of converting it to little endian.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="fury-header">Fury header<a href="#fury-header" class="hash-link" aria-label="Fury header的直接链接" title="Fury header的直接链接">​</a></h2>
<p>Fury header consists starts one byte:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">|    2 bytes   |     4 bits    | 1 bit | 1 bit | 1 bit  | 1 bit |   1 byte   |          optional 4 bytes          |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+--------------+---------------+-------+-------+--------+-------+------------+------------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| magic number | reserved bits |  oob  | xlang | endian | null  |  language  | unsigned int for meta start offset |</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>magic number: used to identify fury serialization protocol, current version use <code>0x62d4</code>.</li>
<li>null flag: 1 when object is null, 0 otherwise. If an object is null, other bits won&#x27;t be set.</li>
<li>endian flag: 1 when data is encoded by little endian, 0 for big endian.</li>
<li>xlang flag: 1 when serialization uses xlang format, 0 when serialization uses Fury java format.</li>
<li>oob flag: 1 when passed <code>BufferCallback</code> is not null, 0 otherwise.</li>
<li>language: the language when serializing objects, such as JAVA, PYTHON, GO, etc. Fury can use this flag to determine whether spend more time on serialization to make the deserialization faster for dynamic languages.</li>
</ul>
<p>If meta share mode is enabled, an uncompressed unsigned int is appended to indicate the start offset of metadata.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reference-meta">Reference Meta<a href="#reference-meta" class="hash-link" aria-label="Reference Meta的直接链接" title="Reference Meta的直接链接">​</a></h2>
<p>Reference tracking handles whether the object is null, and whether to track reference for the object by writing
corresponding flags and maintaining internal state.</p>
<p>Reference flags:</p>
<table><thead><tr><th>Flag</th><th>Byte Value</th><th>Description</th></tr></thead><tbody><tr><td>NULL FLAG</td><td><code>-3</code></td><td>This flag indicates the object is a null value. We don&#x27;t use another byte to indicate REF, so that we can save one byte.</td></tr><tr><td>REF FLAG</td><td><code>-2</code></td><td>This flag indicates the object is already serialized previously, and fury will write a ref id with unsigned varint format instead of serialize it again</td></tr><tr><td>NOT_NULL VALUE FLAG</td><td><code>-1</code></td><td>This flag indicates the object is a non-null value and fury doesn&#x27;t track ref for this type of object.</td></tr><tr><td>REF VALUE FLAG</td><td><code>0</code></td><td>This flag indicates the object is referencable and the first time to serialize.</td></tr></tbody></table>
<p>When reference tracking is disabled globally or for specific types, or for certain types within a particular
context(e.g., a field of a type), only the <code>NULL</code> and <code>NOT_NULL VALUE</code> flags will be used for reference meta.</p>
<p>For languages which doesn&#x27;t support reference such as rust, reference tracking must be disabled for correct
deserialization by fury rust implementation.</p>
<p>For languages whose object values are not null by default:</p>
<ul>
<li>In rust, Fury takes <code>Option:None</code> as a null value</li>
<li>In c++, Fury takes <code>std::nullopt</code> as a null value</li>
<li>In golang, Fury takes <code>null interface/pointer</code> as a null value</li>
</ul>
<p>If one want to deserialize in languages like <code>Java/Python/JavaScript</code>, he should mark the type with all fields
not-null by default, or using schema-evolution mode to carry the not-null fields info in the data.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="type-meta">Type Meta<a href="#type-meta" class="hash-link" aria-label="Type Meta的直接链接" title="Type Meta的直接链接">​</a></h2>
<p>For every type to be serialized, it must be registered with an optional ID first. The registered type will have a
user-provided or an auto-growing unsigned int i.e. <code>type_id</code>. The registration can be used for security check and type
identification. The id of user registered type will be added by <code>64</code> to make space for Fury internal data types.</p>
<p>Depending on whether meta share mode and registration is enabled for current type, Fury will write type meta
differently.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="schema-consistent">Schema consistent<a href="#schema-consistent" class="hash-link" aria-label="Schema consistent的直接链接" title="Schema consistent的直接链接">​</a></h3>
<ul>
<li>If schema consistent mode is enabled globally when creating fury, type meta will be written as a fury unsigned varint
of <code>type_id</code>. Schema evolution related meta will be ignored.</li>
<li>If schema evolution mode is enabled globally when creating fury, and current class is configured to use schema
consistent mode like <code>struct</code> vs <code>table</code> in flatbuffers:<!-- -->
<ul>
<li>Type meta will be add to <code>captured_type_defs</code>: <code>captured_type_defs[type def stub] = map size</code> ahead when
registering type.</li>
<li>Get index of the meta in <code>captured_type_defs</code>, write that index as <code>| unsigned varint: index |</code>.</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="schema-evolution">Schema evolution<a href="#schema-evolution" class="hash-link" aria-label="Schema evolution的直接链接" title="Schema evolution的直接链接">​</a></h3>
<p>If schema evolution mode is enabled globally when creating fury, and enabled for current type, type meta will be written
using one of the following mode. Which mode to use is configured when creating fury.</p>
<ul>
<li>
<p>Normal mode(meta share not enabled):</p>
<ul>
<li>If type meta hasn&#x27;t been written before, add <code>type def</code>
to <code>captured_type_defs</code>: <code>captured_type_defs[type def] = map size</code>.</li>
<li>Get index of the meta in <code>captured_type_defs</code>, write that index as <code>| unsigned varint: index |</code>.</li>
<li>After finished the serialization of the object graph, fury will start to write <code>captured_type_defs</code>:<!-- -->
<ul>
<li>
<p>Firstly, set current to <code>meta start offset</code> of fury header</p>
</li>
<li>
<p>Then write <code>captured_type_defs</code> one by one:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin">buffer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write_var_uint32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">writting_type_defs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">schema_consistent_type_def_stubs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> type_meta </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> writting_type_defs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> type_meta</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_stub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        type_meta</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write_type_def</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">buffer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">writing_type_defs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> copy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">schema_consistent_type_def_stubs</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Meta share mode: the writing steps are same as the normal mode, but <code>captured_type_defs</code> will be shared across
multiple serializations of different objects. For example, suppose we have a batch to serialize:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">captured_type_defs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stream </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># add `Type1` to `captured_type_defs` and write `Type1`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fury</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">serialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Type1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># add `Type2` to `captured_type_defs` and write `Type2`, `Type1` is written before.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fury</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">serialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Type1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Type2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># `Type1` and `Type2` are written before, no need to write meta.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fury</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">serialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Type1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Type2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Streaming mode(streaming mode doesn&#x27;t support meta share):</p>
<ul>
<li>
<p>If type meta hasn&#x27;t been written before, the data will be written as:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">| unsigned varint: 0b11111111 | type def |</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>If type meta has been written before, the data will be written as:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">| unsigned varint: written index &lt;&lt; 1 |</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>written index</code> is the id in <code>captured_type_defs</code>.</p>
</li>
<li>
<p>With this mode, <code>meta start offset</code> can be omitted.</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>The normal mode and meta share mode will forbid streaming writing since it needs to look back for update the start
offset after the whole object graph writing and meta collecting is finished. Only in this way we can ensure
deserialization failure in meta share mode doesn&#x27;t lost shared meta.</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="type-def">Type Def<a href="#type-def" class="hash-link" aria-label="Type Def的直接链接" title="Type Def的直接链接">​</a></h4>
<p>Here we mainly describe the meta layout for schema evolution mode:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">|      8 bytes meta header      |   variable bytes   |  variable bytes   | variable bytes |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------------------------+--------------------+-------------------+----------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 7 bytes hash + 1 bytes header |  current type meta |  parent type meta |      ...       |</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Type meta are encoded from parent type to leaf type, only type with serializable fields will be encoded.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="meta-header">Meta header<a href="#meta-header" class="hash-link" aria-label="Meta header的直接链接" title="Meta header的直接链接">​</a></h5>
<p>Meta header is a 64 bits number value encoded in little endian order.</p>
<ul>
<li>Lowest 4 digits <code>0b0000~0b1110</code> are used to record num classes. <code>0b1111</code> is preserved to indicate that Fury need to
read more bytes for length using Fury unsigned int encoding. If current type doesn&#x27;t has parent type, or parent
type doesn&#x27;t have fields to serialize, or we&#x27;re in a context which serialize fields of current type
only, num classes will be 1.</li>
<li>The 5th bit is used to indicate whether this type needs schema evolution.</li>
<li>Other 56 bits are used to store the unique hash of <code>flags + all layers type meta</code>.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="single-layer-type-meta">Single layer type meta<a href="#single-layer-type-meta" class="hash-link" aria-label="Single layer type meta的直接链接" title="Single layer type meta的直接链接">​</a></h5>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">| unsigned varint | var uint |  field info: variable bytes   | variable bytes  | ... |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------------+----------+-------------------------------+-----------------+-----+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   num_fields    | type id  | header + type id + field name | next field info | ... |</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>num fields: encode <code>num fields</code> as unsigned varint.<!-- -->
<ul>
<li>If the current type is schema consistent, then num_fields will be <code>0</code> to flag it.</li>
<li>If the current type isn&#x27;t schema consistent, then num_fields will be the number of compatible fields. For example,
users can use tag id to mark some fields as compatible fields in schema consistent context. In such cases, schema
consistent fields will be serialized first, then compatible fields will be serialized next. At deserialization,
Fury will use fields info of those fields which aren&#x27;t annotated by tag id for deserializing schema consistent
fields, then use fields info in meta for deserializing compatible fields.</li>
</ul>
</li>
<li>type id: the registered id for the current type, which will be written as an unsigned varint.</li>
<li>field info:<!-- -->
<ul>
<li>header(8
bits): <code>3 bits size + 2 bits field name encoding + polymorphism flag + nullability flag + ref tracking flag</code>.
Users can use annotation to provide those info.<!-- -->
<ul>
<li>2 bits field name encoding:<!-- -->
<ul>
<li>encoding: <code>UTF8/ALL_TO_LOWER_SPECIAL/LOWER_UPPER_DIGIT_SPECIAL/TAG_ID</code></li>
<li>If tag id is used, i.e. field name is written by an unsigned varint tag id. 2 bits encoding will be <code>11</code>.</li>
</ul>
</li>
<li>size of field name:<!-- -->
<ul>
<li>The <code>3 bits size: 0~7</code>  will be used to indicate length <code>1~7</code>, the value <code>7</code> indicates to read more bytes,
the encoding will encode <code>size - 7</code> as a varint next.</li>
<li>If encoding is <code>TAG_ID</code>, then num_bytes of field name will be used to store tag id.</li>
</ul>
</li>
<li>ref tracking: when set to 1, ref tracking will be enabled for this field.</li>
<li>nullability: when set to 1, this field can be null.</li>
<li>polymorphism: when set to 1, the actual type of field will be the declared field type even the type if
not <code>final</code>.</li>
</ul>
</li>
<li>field name: If tag id is set, tag id will be used instead. Otherwise meta string encoding <code>[length]</code> and data will
be written instead.</li>
<li>type id:<!-- -->
<ul>
<li>For registered type-consistent classes, it will be the registered type id.</li>
<li>Otherwise it will be encoded as <code>OBJECT_ID</code> if it isn&#x27;t <code>final</code> and <code>FINAL_OBJECT_ID</code> if it&#x27;s <code>final</code>. The
meta for such types is written separately instead of inlining here is to reduce meta space cost if object of
this type is serialized in current object graph multiple times, and the field value may be null too.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Field order are left as implementation details, which is not exposed to specification, the deserialization need to
resort fields based on Fury field comparator. In this way, fury can compute statistics for field names or types and
using a more compact encoding.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="other-layers-type-meta">Other layers type meta<a href="#other-layers-type-meta" class="hash-link" aria-label="Other layers type meta的直接链接" title="Other layers type meta的直接链接">​</a></h5>
<p>Same encoding algorithm as the previous layer.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="meta-string">Meta String<a href="#meta-string" class="hash-link" aria-label="Meta String的直接链接" title="Meta String的直接链接">​</a></h2>
<p>Meta string is mainly used to encode meta strings such as field names.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="encoding-algorithms">Encoding Algorithms<a href="#encoding-algorithms" class="hash-link" aria-label="Encoding Algorithms的直接链接" title="Encoding Algorithms的直接链接">​</a></h3>
<p>String binary encoding algorithm:</p>
<table><thead><tr><th>Algorithm</th><th>Pattern</th><th>Description</th></tr></thead><tbody><tr><td>LOWER_SPECIAL</td><td><code>a-z._$|</code></td><td>every char is written using 5 bits, <code>a-z</code>: <code>0b00000~0b11001</code>, <code>._$|</code>: <code>0b11010~0b11101</code>, prepend one bit at the start to indicate whether strip last char since last byte may have 7 redundant bits(1 indicates strip last char)</td></tr><tr><td>LOWER_UPPER_DIGIT_SPECIAL</td><td><code>a-zA-Z0~9._</code></td><td>every char is written using 6 bits, <code>a-z</code>: <code>0b00000~0b11001</code>, <code>A-Z</code>: <code>0b11010~0b110011</code>, <code>0~9</code>: <code>0b110100~0b111101</code>, <code>._</code>: <code>0b111110~0b111111</code>,  prepend one bit at the start to indicate whether strip last char since last byte may have 7 redundant bits(1 indicates strip last char)</td></tr><tr><td>UTF-8</td><td>any chars</td><td>UTF-8 encoding</td></tr></tbody></table>
<p>Encoding flags:</p>
<table><thead><tr><th>Encoding Flag</th><th>Pattern</th><th>Encoding Algorithm</th></tr></thead><tbody><tr><td>LOWER_SPECIAL</td><td>every char is in <code>a-z._|</code></td><td><code>LOWER_SPECIAL</code></td></tr><tr><td>FIRST_TO_LOWER_SPECIAL</td><td>every char is in <code>a-z._</code> except first char is upper case</td><td>replace first upper case char to lower case, then use <code>LOWER_SPECIAL</code></td></tr><tr><td>ALL_TO_LOWER_SPECIAL</td><td>every char is in <code>a-zA-Z._</code></td><td>replace every upper case char by <code>|</code> + <code>lower case</code>, then use <code>LOWER_SPECIAL</code>, use this encoding if it&#x27;s smaller than Encoding <code>LOWER_UPPER_DIGIT_SPECIAL</code></td></tr><tr><td>LOWER_UPPER_DIGIT_SPECIAL</td><td>every char is in <code>a-zA-Z._</code></td><td>use <code>LOWER_UPPER_DIGIT_SPECIAL</code> encoding if it&#x27;s smaller than Encoding <code>FIRST_TO_LOWER_SPECIAL</code></td></tr><tr><td>UTF8</td><td>any utf-8 char</td><td>use <code>UTF-8</code> encoding</td></tr><tr><td>Compression</td><td>any utf-8 char</td><td>lossless compression</td></tr></tbody></table>
<p>Notes:</p>
<ul>
<li>Depending on cases, one can choose encoding <code>flags + data</code> jointly, uses 3 bits of first byte for flags and other
bytes
for data.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="value-format">Value Format<a href="#value-format" class="hash-link" aria-label="Value Format的直接链接" title="Value Format的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="basic-types">Basic types<a href="#basic-types" class="hash-link" aria-label="Basic types的直接链接" title="Basic types的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="bool">bool<a href="#bool" class="hash-link" aria-label="bool的直接链接" title="bool的直接链接">​</a></h4>
<ul>
<li>size: 1 byte</li>
<li>format: 0 for <code>false</code>, 1 for <code>true</code></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="int8">int8<a href="#int8" class="hash-link" aria-label="int8的直接链接" title="int8的直接链接">​</a></h4>
<ul>
<li>size: 1 byte</li>
<li>format: write as pure byte.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="int16">int16<a href="#int16" class="hash-link" aria-label="int16的直接链接" title="int16的直接链接">​</a></h4>
<ul>
<li>size: 2 byte</li>
<li>byte order: raw bytes of little endian order</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="unsigned-int32">unsigned int32<a href="#unsigned-int32" class="hash-link" aria-label="unsigned int32的直接链接" title="unsigned int32的直接链接">​</a></h4>
<ul>
<li>size: 4 byte</li>
<li>byte order: raw bytes of little endian order</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="unsigned-varint32">unsigned varint32<a href="#unsigned-varint32" class="hash-link" aria-label="unsigned varint32的直接链接" title="unsigned varint32的直接链接">​</a></h4>
<ul>
<li>size: 1~5 byte</li>
<li>Format: The most significant bit (MSB) in every byte indicates whether to have the next byte. If first bit is set
i.e. <code>b &amp; 0x80 == 0x80</code>, then
the next byte should be read until the first bit of the next byte is unset.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="signed-int32">signed int32<a href="#signed-int32" class="hash-link" aria-label="signed int32的直接链接" title="signed int32的直接链接">​</a></h4>
<ul>
<li>size: 4 byte</li>
<li>byte order: raw bytes of little endian order</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="signed-varint32">signed varint32<a href="#signed-varint32" class="hash-link" aria-label="signed varint32的直接链接" title="signed varint32的直接链接">​</a></h4>
<ul>
<li>size: 1~5 byte</li>
<li>Format: First convert the number into positive unsigned int by <code>(v &lt;&lt; 1) ^ (v &gt;&gt; 31)</code> ZigZag algorithm, then encode
it as an unsigned varint.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="unsigned-int64">unsigned int64<a href="#unsigned-int64" class="hash-link" aria-label="unsigned int64的直接链接" title="unsigned int64的直接链接">​</a></h4>
<ul>
<li>size: 8 byte</li>
<li>byte order: raw bytes of little endian order</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="unsigned-varint64">unsigned varint64<a href="#unsigned-varint64" class="hash-link" aria-label="unsigned varint64的直接链接" title="unsigned varint64的直接链接">​</a></h4>
<ul>
<li>size: 1~9 byte</li>
<li>Fury SLI(Small long as int) Encoding:<!-- -->
<ul>
<li>If long is in <code>[0, 2147483647]</code>, encode as 4 bytes int: <code>| little-endian: ((int) value) &lt;&lt; 1 |</code></li>
<li>Otherwise write as 9 bytes: <code>| 0b1 | little-endian 8 bytes long |</code></li>
</ul>
</li>
<li>Fury PVL(Progressive Variable-length Long) Encoding:<!-- -->
<ul>
<li>positive long format: first bit in every byte indicates whether to have the next byte. If first bit is set
i.e. <code>b &amp; 0x80 == 0x80</code>, then the next byte should be read until the first bit is unset.</li>
</ul>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="signed-int64">signed int64<a href="#signed-int64" class="hash-link" aria-label="signed int64的直接链接" title="signed int64的直接链接">​</a></h4>
<ul>
<li>size: 8 byte</li>
<li>byte order: raw bytes of little endian order</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="signed-varint64">signed varint64<a href="#signed-varint64" class="hash-link" aria-label="signed varint64的直接链接" title="signed varint64的直接链接">​</a></h4>
<ul>
<li>size: 1~9 byte</li>
<li>Fury SLI(Small long as int) Encoding:<!-- -->
<ul>
<li>If long is in <code>[-1073741824, 1073741823]</code>, encode as 4 bytes int: <code>| little-endian: ((int) value) &lt;&lt; 1 |</code></li>
<li>Otherwise write as 9 bytes: <code>| 0b1 | little-endian 8 bytes long |</code></li>
</ul>
</li>
<li>Fury PVL(Progressive Variable-length Long) Encoding:<!-- -->
<ul>
<li>First convert the number into positive unsigned long by <code>(v &lt;&lt; 1) ^ (v &gt;&gt; 63)</code> ZigZag algorithm to reduce cost of
small negative numbers, then encoding it as an unsigned long.</li>
</ul>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="float32">float32<a href="#float32" class="hash-link" aria-label="float32的直接链接" title="float32的直接链接">​</a></h4>
<ul>
<li>size: 4 byte</li>
<li>format: encode the specified floating-point value according to the IEEE 754 floating-point &quot;single format&quot; bit layout,
preserving Not-a-Number (NaN) values, then write as binary by little endian order.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="float64">float64<a href="#float64" class="hash-link" aria-label="float64的直接链接" title="float64  的直接链接">​</a></h4>
<ul>
<li>size: 8 byte</li>
<li>format: encode the specified floating-point value according to the IEEE 754 floating-point &quot;double format&quot; bit layout,
preserving Not-a-Number (NaN) values. then write as binary by little endian order.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="string">string<a href="#string" class="hash-link" aria-label="string的直接链接" title="string的直接链接">​</a></h3>
<p>Format:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">| unsigned varint64: size &lt;&lt; 2 `bitor` 2 bits encoding flags | binary data |</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><code>size + encoding</code> will be concat as a long and encoded as an unsigned varint64. The little 2 bits is used for
encoding:
0 for <code>latin1(ISO-8859-1)</code>, 1 for <code>utf-16</code>, 2 for <code>utf-8</code>.</li>
<li>encoded string binary data based on encoding: <code>latin/utf-16/utf-8</code>.</li>
</ul>
<p>Which encoding to choose:</p>
<ul>
<li>For JDK8: fury detect <code>latin</code> at runtime, if string is <code>latin</code> string, then use <code>latin</code> encoding, otherwise
use <code>utf-16</code>.</li>
<li>For JDK9+: fury use <code>coder</code> in <code>String</code> object for encoding, <code>latin</code>/<code>utf-16</code> will be used for encoding.</li>
<li>If the string is encoded by <code>utf-8</code>, then fury will use <code>utf-8</code> to decode the data. Cross-language string
serialization of fury uses <code>utf-8</code> by default.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="list">list<a href="#list" class="hash-link" aria-label="list的直接链接" title="list的直接链接">​</a></h3>
<p>Format:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">| unsigned varint64: length &lt;&lt; 4 `bitor` 4 bits elements header | elements data |</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="elements-header">elements header<a href="#elements-header" class="hash-link" aria-label="elements header的直接链接" title="elements header的直接链接">​</a></h4>
<p>In most cases, all elements are same type and not null, elements header will encode those homogeneous
information to avoid the cost of writing it for every element. Specifically, there are four kinds of information
which will be encoded by elements header, each use one bit:</p>
<ul>
<li>If track elements ref, use the first bit <code>0b1</code> of the header to flag it.</li>
<li>If the elements have null, use the second bit <code>0b10</code> of the header to flag it. If ref tracking is enabled for this
element type, this flag is invalid.</li>
<li>If the element types are not the declared type, use the 3rd bit <code>0b100</code> of the header to flag it.</li>
<li>If the element types are different, use the 4rd bit <code>0b1000</code> header to flag it.</li>
</ul>
<p>By default, all bits are unset, which means all elements won&#x27;t track ref, all elements are same type, not null and
the actual element is the declared type in the custom type field.</p>
<p>The implementation can generate different deserialization code based read header, and look up the generated code from
a linear map/list.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="elements-data">elements data<a href="#elements-data" class="hash-link" aria-label="elements data的直接链接" title="elements data的直接链接">​</a></h4>
<p>Based on the elements header, the serialization of elements data may skip <code>ref flag</code>/<code>null flag</code>/<code>element type info</code>.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">fury </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">buffer</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">elems </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> element_type_is_same</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> is_declared_type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fury</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write_type</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">buffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> elem_type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    elem_serializer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> get_serializer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> track_ref</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> elem </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> elems</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> ref_resolver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write_ref_or_null</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">buffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> elem</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elem_serializer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">buffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> elem</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> has_null</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> elem </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> elems</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> elem </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token builtin">buffer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write_byte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">null_flag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token builtin">buffer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write_byte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">not_null_flag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                elem_serializer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">buffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> elem</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> elem </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> elems</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            elem_serializer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">buffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> elem</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> track_ref</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> elem </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> elems</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fury</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write_ref</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">buffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> elem</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> has_null</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> elem </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> elems</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fury</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write_nullable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">buffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> elem</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> elem </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> elems</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            fury</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write_value</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">buffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> elem</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><a href="https://github.com/apache/fury/blob/20a1a78b17a75a123a6f5b7094c06ff77defc0fe/java/fury-core/src/main/java/org/apache/fury/serializer/collection/AbstractCollectionSerializer.java#L302" target="_blank" rel="noopener noreferrer"><code>CollectionSerializer#writeElements</code></a>
can be taken as an example.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="array">array<a href="#array" class="hash-link" aria-label="array的直接链接" title="array的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="primitive-array">primitive array<a href="#primitive-array" class="hash-link" aria-label="primitive array的直接链接" title="primitive array的直接链接">​</a></h4>
<p>Primitive array are taken as a binary buffer, serialization will just write the length of array size as an unsigned int,
then copy the whole buffer into the stream.</p>
<p>Such serialization won&#x27;t compress the array. If users want to compress primitive array, users need to register custom
serializers for such types or mark it as list type.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="object-array">object array<a href="#object-array" class="hash-link" aria-label="object array的直接链接" title="object array的直接链接">​</a></h4>
<p>Object array is serialized using the list format. Object component type will be taken as list element
generic type.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="map">map<a href="#map" class="hash-link" aria-label="map的直接链接" title="map的直接链接">​</a></h3>
<blockquote>
<p>All Map serializers must extend <code>AbstractMapSerializer</code>.</p>
</blockquote>
<p>Format:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">| length(unsigned varint) | key value chunk data | ... | key value chunk data |</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="map-key-value-chunk-data">map key-value chunk data<a href="#map-key-value-chunk-data" class="hash-link" aria-label="map key-value chunk data的直接链接" title="map key-value chunk data的直接链接">​</a></h4>
<p>Map iteration is too expensive, Fury won&#x27;t compute the header like for list since it introduce
<a href="https://github.com/apache/fury/issues/925" target="_blank" rel="noopener noreferrer">considerable overhead</a>.
Users can use <code>MapFieldInfo</code> annotation to provide the header in advance. Otherwise Fury will use first key-value pair
to predict header optimistically, and update the chunk header if the prediction failed at some pair.</p>
<p>Fury will serialize the map chunk by chunk, every chunk has 255 pairs at most.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">|    1 byte      |     1 byte     | variable bytes  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------------+----------------+-----------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| chunk size: N  |    KV header   |   N*2 objects   |</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>KV header:</p>
<ul>
<li>If track key ref, use the first bit <code>0b1</code> of the header to flag it.</li>
<li>If the key has null, use the second bit <code>0b10</code> of the header to flag it. If ref tracking is enabled for this
key type, this flag is invalid.</li>
<li>If the key types of map are different, use the 3rd bit <code>0b100</code> of the header to flag it.</li>
<li>If the actual key type of the map is not the declared key type, use the 4rd bit <code>0b1000</code> of the header to flag it.</li>
<li>If track value ref, use the 5th bit <code>0b10000</code> of the header to flag it.</li>
<li>If the value has null, use the 6th bit <code>0b100000</code> of the header to flag it. If ref tracking is enabled for this
value type, this flag is invalid.</li>
<li>If the value types of the map are different, use the 7rd bit <code>0b1000000</code> header to flag it.</li>
<li>If the value type of map is not the declared value type, use the 8rd bit <code>0b10000000</code> of the header to flag it.</li>
</ul>
<p>If streaming write is enabled, which means Fury can&#x27;t update written <code>chunk size</code>. In such cases, map key-value data
format will be:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">|    1 byte      | variable bytes  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------------+-----------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|    KV header   |   N*2 objects   |</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>KV header</code> will be a header marked by <code>MapFieldInfo</code> in java. For languages such as golang, this can be computed in
advance for non-interface types most times. The implementation can generate different deserialization code based read
header, and look up the generated code from a linear map/list.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="why-serialize-chunk-by-chunk">Why serialize chunk by chunk?<a href="#why-serialize-chunk-by-chunk" class="hash-link" aria-label="Why serialize chunk by chunk?的直接链接" title="Why serialize chunk by chunk?的直接链接">​</a></h4>
<p>When fury will use first key-value pair to predict header optimistically, it can&#x27;t know how many pairs have same
meta(tracking kef ref, key has null and so on). If we don&#x27;t write chunk by chunk with max chunk size, we must write at
least <code>X</code> bytes to take up a place for later to update the number which has same elements, <code>X</code> is the num_bytes for
encoding varint encoding of map size.</p>
<p>And most map size are smaller than 255, if all pairs have same data, the chunk will be 1. This is common in golang/rust,
which object are not reference by default.</p>
<p>Also, if only one or two keys have different meta, we can make it into a different chunk, so that most pairs can share
meta.</p>
<p>The implementation can accumulate read count with map size to decide whether to read more chunks.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="enum">enum<a href="#enum" class="hash-link" aria-label="enum的直接链接" title="enum的直接链接">​</a></h3>
<p>Enums are serialized as an unsigned var int. If the order of enum values change, the deserialized enum value may not be
the value users expect. In such cases, users must register enum serializer by make it write enum value as an enumerated
string with unique hash disabled.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="decimal">decimal<a href="#decimal" class="hash-link" aria-label="decimal的直接链接" title="decimal的直接链接">​</a></h3>
<p>Not supported for now.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="struct">struct<a href="#struct" class="hash-link" aria-label="struct的直接链接" title="struct的直接链接">​</a></h3>
<p>Struct means object of <code>class/pojo/struct/bean/record</code> type.
Struct will be serialized by writing its fields data in fury order.</p>
<p>Depending on schema compatibility, structs will have different formats.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="field-order">field order<a href="#field-order" class="hash-link" aria-label="field order的直接链接" title="field order的直接链接">​</a></h4>
<p>Field will be ordered as following, every group of fields will have its own order:</p>
<ul>
<li>primitive fields: larger size type first, smaller later, variable size type last.</li>
<li>boxed primitive fields: same order as primitive fields</li>
<li>final fields: same type together, then sorted by field name lexicographically.</li>
<li>list fields: same order as final fields</li>
<li>map fields: same order as final fields</li>
<li>other fields: same order as final fields</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="schema-consistent-1">schema consistent<a href="#schema-consistent-1" class="hash-link" aria-label="schema consistent的直接链接" title="schema consistent的直接链接">​</a></h4>
<p>Object will be written as:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">|    4 byte     |  variable bytes  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+---------------+------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   type hash   |   field values   |</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Type hash is used to check the type schema consistency across languages. Type hash will be the first 32 bits of 56 bits
value of the type meta.</p>
<p>Object fields will be serialized one by one using following format:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">not null primitive field value:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   var bytes    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|   value data   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+----------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nullable primitive field value:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| one byte  |   var bytes   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------+---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| null flag |  field value  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------+---------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">field value of final type with ref tracking:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| var bytes | var objects |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------+-------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| ref meta  | value data  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------+-------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">field value of final type without ref tracking:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| one byte  | var objects |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------+-------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| null flag | field value |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------+-------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">field value of non-final type with ref tracking:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| one byte  | var bytes | var objects |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------+-------------+-------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| ref meta  | type meta  | value data  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------+-------------+-------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">field value of non-final type without ref tracking:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| one byte  | var bytes | var objects |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------+------------+------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| null flag | type meta | value data |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+-----------+------------+------------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="schema-evolution-1">Schema evolution<a href="#schema-evolution-1" class="hash-link" aria-label="Schema evolution的直接链接" title="Schema evolution的直接链接">​</a></h4>
<p>Schema evolution have similar format as schema consistent mode for object except:</p>
<ul>
<li>For the object type, <code>schema consistent</code> mode will write type by id only, but <code>schema evolution</code> mode will
write type consisting of field names, types and other meta too, see <a href="#type-meta">Type meta</a>.</li>
<li>Type meta of <code>final custom type</code> needs to be written too, because peers may not have this type defined.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="type">Type<a href="#type" class="hash-link" aria-label="Type的直接链接" title="Type的直接链接">​</a></h3>
<p>Type will be serialized using type meta format.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="implementation-guidelines">Implementation guidelines<a href="#implementation-guidelines" class="hash-link" aria-label="Implementation guidelines的直接链接" title="Implementation guidelines的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-reduce-memory-readwrite-code">How to reduce memory read/write code<a href="#how-to-reduce-memory-readwrite-code" class="hash-link" aria-label="How to reduce memory read/write code的直接链接" title="How to reduce memory read/write code的直接链接">​</a></h3>
<ul>
<li>Try to merge multiple bytes into an int/long write before writing to reduce memory IO and bound check cost.</li>
<li>Read multiple bytes as an int/long, then split into multiple bytes to reduce memory IO and bound check cost.</li>
<li>Try to use one varint/long to write flags and length together to save one byte cost and reduce memory io.</li>
<li>Condition branches are less expensive compared to memory IO cost unless there are too many branches.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fast-deserialization-for-static-languages-without-runtime-codegen-support">Fast deserialization for static languages without runtime codegen support<a href="#fast-deserialization-for-static-languages-without-runtime-codegen-support" class="hash-link" aria-label="Fast deserialization for static languages without runtime codegen support的直接链接" title="Fast deserialization for static languages without runtime codegen support的直接链接">​</a></h3>
<p>For type evolution, the serializer will encode the type meta into the serialized data. The deserializer will compare
this meta with class meta in the current process, and use the diff to determine how to deserialize the data.</p>
<p>For java/javascript/python, we can use the diff to generate serializer code at runtime and load it as class/function for
deserialization. In this way, the type evolution will be as fast as type consist mode.</p>
<p>For C++/Rust, we can&#x27;t generate the serializer code at runtime. So we need to generate the code at compile-time using
meta programming. But at that time, we don&#x27;t know the type schema in other processes, so we can&#x27;t generate the
serializer code for such inconsistent types. We may need to generate the code which has a loop and compare field name
one by one to decide whether to deserialize and assign the field or skip the field value.</p>
<p>One fast way is that we can optimize the string comparison into <code>jump</code> instructions:</p>
<ul>
<li>Assume the current type has <code>n</code> fields, and the peer type has <code>n1</code> fields.</li>
<li>Generate an auto growing <code>field id</code> from <code>0</code> for every sorted field in the current type at the compile time.</li>
<li>Compare the received type meta with current type, generate same id if the field name is same, otherwise generate an
auto growing id starting from <code>n</code>, cache this meta at runtime.</li>
<li>Iterate the fields of received type meta, use a <code>switch</code> to compare the <code>field id</code> to deserialize data
and <code>assign/skip</code> field value. <strong>Continuous</strong> field id will be optimized into <code>jump</code> in <code>switch</code> block, so it will
very fast.</li>
</ul>
<p>Here is an example, suppose process A has a class <code>Foo</code> with version 1 defined as <code>Foo1</code>, process B has a class <code>Foo</code>
with version 2 defined as <code>Foo2</code>:</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// class Foo with version 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class Foo1 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  int32_t v1; // id 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  std::string v2; // id 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// class Foo with version 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class Foo2 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // id 0, but will have id 2 in process A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bool v0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // id 1, but will have id 0 in process A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  int32_t v1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // id 2, but will have id 3 in process A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  int64_t long_value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // id 3, but will have id 1 in process A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  std::string v2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // id 4, but will have id 4 in process A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  std::vector&lt;std::string&gt; list;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When process A received serialized <code>Foo2</code> from process B, here is how it deserialize the data:</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Foo1 foo1 = ...;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const std::vector&lt;fury::FieldInfo&gt; &amp;field_infos = type_meta.field_infos;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">for (const auto &amp;field_info : field_infos) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  switch (field_info.field_id) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case 0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      foo1.v1 = buffer.read_varint32();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    case 1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      foo1.v2 = fury.read_string();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      fury.skip_data(field_info);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--next" href="/zh-CN/docs/specification/fury_java_serialization_spec"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Fury Java Serialization Specification</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#type-systems" class="table-of-contents__link toc-highlight">Type Systems</a><ul><li><a href="#data-types" class="table-of-contents__link toc-highlight">Data Types</a></li><li><a href="#type-disambiguation" class="table-of-contents__link toc-highlight">Type disambiguation</a></li><li><a href="#type-id" class="table-of-contents__link toc-highlight">Type ID</a></li><li><a href="#type-mapping" class="table-of-contents__link toc-highlight">Type mapping</a></li></ul></li><li><a href="#spec-overview" class="table-of-contents__link toc-highlight">Spec overview</a></li><li><a href="#fury-header" class="table-of-contents__link toc-highlight">Fury header</a></li><li><a href="#reference-meta" class="table-of-contents__link toc-highlight">Reference Meta</a></li><li><a href="#type-meta" class="table-of-contents__link toc-highlight">Type Meta</a><ul><li><a href="#schema-consistent" class="table-of-contents__link toc-highlight">Schema consistent</a></li><li><a href="#schema-evolution" class="table-of-contents__link toc-highlight">Schema evolution</a></li></ul></li><li><a href="#meta-string" class="table-of-contents__link toc-highlight">Meta String</a><ul><li><a href="#encoding-algorithms" class="table-of-contents__link toc-highlight">Encoding Algorithms</a></li></ul></li><li><a href="#value-format" class="table-of-contents__link toc-highlight">Value Format</a><ul><li><a href="#basic-types" class="table-of-contents__link toc-highlight">Basic types</a></li><li><a href="#string" class="table-of-contents__link toc-highlight">string</a></li><li><a href="#list" class="table-of-contents__link toc-highlight">list</a></li><li><a href="#array" class="table-of-contents__link toc-highlight">array</a></li><li><a href="#map" class="table-of-contents__link toc-highlight">map</a></li><li><a href="#enum" class="table-of-contents__link toc-highlight">enum</a></li><li><a href="#decimal" class="table-of-contents__link toc-highlight">decimal</a></li><li><a href="#struct" class="table-of-contents__link toc-highlight">struct</a></li><li><a href="#type" class="table-of-contents__link toc-highlight">Type</a></li></ul></li><li><a href="#implementation-guidelines" class="table-of-contents__link toc-highlight">Implementation guidelines</a><ul><li><a href="#how-to-reduce-memory-readwrite-code" class="table-of-contents__link toc-highlight">How to reduce memory read/write code</a></li><li><a href="#fast-deserialization-for-static-languages-without-runtime-codegen-support" class="table-of-contents__link toc-highlight">Fast deserialization for static languages without runtime codegen support</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">社区</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://lists.apache.org/list.html?dev@fury.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">邮件列表<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://join.slack.com/t/fury-project/shared_invite/zt-1u8soj4qc-ieYEu7ciHOqA2mo47llS8A" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/ApacheFury" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-CN/docs/start/install">安装</a></li><li class="footer__item"><a class="footer__link-item" href="/zh-CN/docs/start/usage">使用</a></li><li class="footer__item"><a class="footer__link-item" href="/zh-CN/docs/introduction/benchmark">基准测试</a></li></ul></div><div class="col footer__col"><div class="footer__title">代码库</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/apache/fury" target="_blank" rel="noopener noreferrer" class="footer__link-item">Fury<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/apache/fury-site" target="_blank" rel="noopener noreferrer" class="footer__link-item">网站<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://incubator.apache.org/" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/zh-CN/img/apache-incubator.svg" alt="Apache Incubator 标志" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE" width="200"><img src="/zh-CN/img/apache-incubator.svg" alt="Apache Incubator 标志" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU" width="200"></a></div><div class="footer__copyright"><div>
      <p> Apache Fury 是 Apache 软件基金会（ASF）孵化过程中的一个项目，由 Apache Incubator 赞助。孵化是所有新接受项目所需的，直到  进一步审查表明基础设施、通信和决策过程已经稳定到与其他成功的 ASF 项目一致的程度。虽然孵化状态不一定反映代码的完整性或稳定性，但它确实表明该项目尚未完全获得 ASF 的认可。 </p>
      <p>
        版权所有 © 2024 The Apache Software Foundation，许可证：Apache License, Version 2.0。 <br>
        Apache、Apache 项目的名称以及羽毛标志是 Apache 软件基金会在美国和/或其他国家的注册商标或商标。
      </p>
      </div></div></div></div></footer></div>
</body>
</html>